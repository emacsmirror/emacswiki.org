This page is about how to install, and update, the [https://github.com/doomemacs/doomemacs Doom Emacs] starter kit in [https://sourceforge.net/projects/android-ports-for-gnu-emacs/ Android Emacs].
For an overview of the different alternatives for running emacs on Android, see EmacsOnAndroid.

Android Emacs can be used with various StarterKits, for example Spacemacs and Doom Emacs.

Doom Emacs works well in Android Emacs, except that installing and updating takes a long time: The script that does the installation or update runs for a long time. This is due to that the script executes emacs as a subprocess multiple times, and Android has poor support for executing an app as a subprocess under itself. Other starter kits do not have this issue, they perform the installation or update without starting a lot of new emacs subprocesses.

=A warning about Android power saving=
It is important to ensure that Android does not attempt to slow down the CPU, or temporarily turn off Wifi, while doing "doom install", "doom upgrade" or "doom sync":
* In Android settings, probably in section "Battery", look for "Power saving", or "performance", and ensure that power saving is disabled, and performance is set to high performace. Note that your version of Android might have only one of these controls.

=Installation=
To get started install the Termux APK and the Android Emacs APK in [https://sourceforge.net/projects/android-ports-for-gnu-emacs/files/termux/ Sourceforge]. Follow the instructions in the README under the same URL. Do not forget to run:
[code]
$ pkg update && pkg upgrade
[/code]

You may need to install additional packages in Termux, such as <tt>git</tt> and <tt>ssh</tt> (<tt>scp</tt>). To check if they are already available:
[code]
$ which git
$ which scp
[/code]

You will need access to Androids internal storage in Termux:
* Make sure permission 'Files and media' is enabled in Permissions for Termux (Android Settings -> Apps -> Termux -> Permissions).
* In termux run <tt>termux-setup-storage</tt>
* You will be prompted to "Allow Termux access photos, media and files on your device", which you should allow.
* Symbolic links to various folders in Android storage, should now be available in directory <tt>~/storage</tt>.
* The user files (Documents, Download, etc) are also available under <tt>/sdcard</tt>. On my Oneplus, the user files are read only under <tt>storage/shared</tt>, but read/write under <tt>/sdcard</tt>

We need to install a symbolic link <tt>emacs</tt> in termux <tt>bin</tt> directory, pointing to an executable that will start Android emacs as a command line application. In Termux:
[code]
$ cd
$ cd ../usr/bin/
$ ln -s /data/data/org.gnu.emacs/lib/libandroid-emacs.so emacs
[/code]

To verify that the link points is not broken:
[code]
$ ls -lL emacs
[/code]

This should give a result similar to:
[code]
 -rwxr-xr-x 1 system system 8112 Jan 1 1980 emacs
[/code]

Now run Android emacs. Start a shell in emacs:
[code]
 M-x shell
[/code]

One can normally use both tilde <tt>'~'</tt> and <tt>$HOME</tt> to refer to emacs home directory, but tilde might not work in certain situations during the Doom Emacs installation or update process, especially when something has failed. But <tt>$HOME</tt> always seems to work.

The default emacs configuration directory is <tt>$HOME/.emacs.d/</tt>

We will install the Doom Emacs files under <tt>$HOME/.config/emacs/</tt>, and our personal config files under <tt>$HOME/.config/doom/</tt>

Create <tt>$HOME/.config</tt> if it has not already been created. In emacs shell:
[code]
$ mkdir -p $HOME/.config
[/code]

Now follow the install instructions on the Doom Emacs github home page. At the time of writing this page, it was:
[code]
$ git clone --depth 1 https://github.com/doomemacs/doomemacs $HOME/.config/emacs
[/code]

There is an additional step, but we must first fix the shebang path in the scripts under <tt>$HOME/.config/emacs/bin/</tt>

Create a directory <tt>$HOME/bin</tt>:
[code]
$ mkdir -p $HOME/bin
[/code]

Create a shell script <tt>$HOME/bin/fix-shell-path</tt>, with the following content:
[code]
#!/system/bin/sh
for i in $@;
do
  grep -q '^#!/usr/bin/env sh' $i && sed -i '1 s;/usr/bin/env sh;/system/bin/sh;' $i
done
[/code]

Make the script executable:
[code]
$ chmod +x $HOME/bin/fix-shell-path
[/code]

Fix the shebang path in the scripts:
[code]
$ cd $HOME/.config/emacs/bin
$ $HOME/bin/fix-shell-path *
[/code]

Check that the scripts have been modified:
[code]
$ ls -l
[/code]

All scripts except <tt>doom.cmd</tt> should have been updated.

Now execute the next step in the installation of Doom Emacs:

[code]
$ cd
$ $HOME/.config/emacs/bin/doom install
[/code]

This will also create and populate <tt>$HOME/.config/doom/</tt>, if it does not already exist.

Now edit <tt>$HOME/doom/init.el</tt> and add the following near the top, before the line <tt>(doom! :input</tt>:
[code]
(when (string-equal system-type "android")
  ;; Add Termux binaries to PATH environment
  ;; It is important that termuxpath is prepended, not appended.
  ;; Otherwise we will get Androids incompatible diff executable, instead of the one in Termux.
  (let ((termuxpath "/data/data/com.termux/files/usr/bin"))
    (setenv "PATH" (format "%s:%s" termuxpath
		       (getenv "PATH")))
    (setenv "LD_LIBRARY_PATH" "/data/data/com.termux/files/usr/lib")
    (push termuxpath exec-path)
    (push "~/.config/emacs/bin" exec-path)))
[/code]

The final step is now to change Android Emacs configuration folder from <tt>~/.emacs.d</tt> to <tt>~/.config/emacs</tt>:
[code]
$ cd
$ mkdir -p save
$ mv .emacs.d save/; ln -s $HOME/.config/emacs .emacs.d
[/code]

Now you can restart emacs, and you should see the Doom start page.

=Updating Android emacs=
To update Android Emacs:
* Download the new Android Emacs APK from sourceforge. This can be done on a computer, or directly using a web browser in Android.
  If the APK was downloaded to a computer, then use Termux <tt>scp</tt> command to transfer the emacs APK to e.g. directory <tt>/storage/emulated/0/Downloads/emacs/</tt>
  which in Termux has path <tt>~/storage/downloads/emacs/</tt>
* Exit Android Emacs, to ensure that useful state is saved before the update.
* Install the APK using an Android file manager.
  For example file manager "Solid Explorer", available in Google Play.
  If one selects the emacs APK in Solid Explorer, Solid will ask if it should update Android Emacs. Answer yes.
  Then Solid will ask if it should start Android Emacs. Answer yes.

Doom Emacs keeps a record of shell environment variables, in file <tt>$HOME/.config/emacs/.local/env</tt>

This file must be regenerated when Android Emacs has been updated. Otherwise the <tt>$HOME/.config/emacs/bin/doom</tt> script will no longer work: <tt>doom</tt> will complain that it can not find emacs.

In Android Emacs:
[code]
M-x shell
$ cd $HOME/.config/emacs/.local
$ mv env old.env
[/code]

Restart emacs.
If emacs can not find binaries that are in Termux bin direcory, then the environment variable PATH will have to be updated, in a shell session. And "doom sync" need to be run, to create and populate directory $HOME/.config/emacs/.local/straight/build-<emacs-version>:
[code]
M-x shell
$ export PATH=/data/data/com.termux/files/usr/bin:$PATH
$ $HOME/.config/emacs/bin/doom sync
[/code]

Restart emacs. Now regenerate the <tt>env</tt> file:
[code]
M-x shell
$ $HOME/.config/emacs/bin/doom env
[/code]

=Updating Doom Emacs=
To upgrade to a new git version of Doom Emacs, in Android Emacs:
[code]
M-x shell
$ doom upgrade --force
[/code]

Fix the shebang path in the scripts:
[code]
$ cd $HOME/.config/emacs/bin
$ $HOME/bin/fix-shell-path *
$ doom sync -u
[/code]

To update after changes to <tt>$HOME/.config/doom/init.el</tt> or <tt>$HOME/.config/packages.el</tt>:
[code]
M-x shell
$ doom sync
[/code]

To update all emacs packages that have got new versions in their repos on the internet:
[code]
M-x shell
$ doom sync -u
[/code]

If you use a literary config file, i.e. if your configuration is in <tt>$HOME/.config/doom/config.org</tt>, then Doom Emacs should automatically tangle this file to <tt>$HOME/.config/doom/config.el</tt>, when you save <tt>config.org</tt>.
This can take a long time, say 10 minutes, so be patient. You should get a message that the file has been tangled. But this tangling may not work if there are configuration errors, so check that <tt>config.el</tt> has been updated, if you are unsure. Running:
[code]
$ doom sync
[/code]

should tangle the file, if the automatic tangling seems to hang.

=Directories for fonts=
Applications may look for fonts in directories <tt>$HOME/fonts</tt> and <tt>$HOME/.local/share/fonts</tt>. Make a symbolic link from one to another, to have a unique font directory:
[code]
M-x shell
$ mkdir -p $HOME/.local/share/fonts
$ ln -s $HOME/.local/share/fonts $HOME/fonts
[/code]

Alternatively, move the font directory to /sdcard/fonts:
[code]
M-x shell
$ cd $HOME
$ tar cf - fonts | (cd /sdcard; tar xf -)
$ mv fonts junk-fonts; ln -s /sdcard/fonts
$ ls /sdcard/fonts/
$ ls fonts
$ cd .local/share
$ ls
$ mv fonts junk-fonts; ln -s /sdcard/fonts
$ ls fonts
[/code]

=Emacs does not look for fonts in sub-dir of fonts directory=
Emacs only searches for fonts/*.ttf. It does not search for fonts in sub-directories of the fonts directory.

=How to change font on the fly=
To change font on the fly, assign a new <tt>font-spec</tt> to <tt>doom-font</tt>, then call <tt>doom/reload-font</tt>:
[code]
(defun my/regular-font ()
  (interactive)
  (setq doom-font (font-spec :family "Iosevka Comfy" :size 20 :weight 'regular)
        doom-variable-pitch-font (font-spec :family "Iosevka Comfy Motion Duo" :size 20))
  (doom/reload-font))
[/code]
Note that <tt>font-spec</tt> does not recognize keyword <tt>:height</tt>.

=Path name in HOME dir, in config file=
To reliably use <tt>$HOME</tt> in a path name, in emacs config file:
[code]
(expand-file-name "storage/shared/stardict" (getenv "HOME"))
[/code]

should expand to <tt>/data/data/org.gnu.emacs/files/storage/shared/stardict</tt>

=Suggestion: Enable menu-bar and tool-bar, after init=
To enable <tt>menu-bar</tt> and <tt>tool-bar</tt>, add the following to emacs config file:
[code]
(add-hook 'after-init-hook
          (lambda ()
            (progn
              (menu-bar-mode 1)
              (tool-bar-mode 1)
              (tooltip-mode 1))))
[/code]

=Suggestion: Move user-emacs-directory to /sdcard/emacs/cache/=
To reduce the risk of loosing precious files such as <tt>recentf</tt> and <tt>bookmarks</tt> it might be a
good idea to move directory <tt>$HOME/.config/emacs/.local/cache/</tt>
to, say, under <tt>/sdcard/emacs/</tt>:
[code]
$ mkdir -p /sdcard/emacs
$ cp -r -p $HOME/.config/emacs/.local/cache/ /sdcard/emacs/
[/code]

Then put the following in your emacs config file:
[code]
(customize-set-variable 'user-emacs-directory "/sdcard/emacs/cache/")
(setq doom-cache-dir user-emacs-directory)
(customize-set-variable 'bookmark-default-file (expand-file-name "bookmarks" user-emacs-directory))
(customize-set-variable 'bookmark-save-flag 1) ; Save bookmark list immediately when it has been updated.
(after! recentf
  (progn
    (setq recentf-max-saved-items 10000) ; Set it to whatever you prefer, the default is too small
    (add-hook 'find-file-hook 'recentf-save-list)))
[/code]

=Suggestion: run "doom doctor", when Doom Emacs has been configured=
When Doom Emacs has been installed and configured, it is a good idea to check that there is nothing amiss, for example expected applications in Termux:
[code]
$ doom doctor
[/code]

CategoryPorts
